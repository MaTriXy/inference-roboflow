import numpy as np
import pytest
import torch
import torch.nn.functional as F
from clip import clip
from PIL.Image import Image

EXPECTED_DOG_IMAGE_EMBEDDING = torch.Tensor(
    [
        [
            -0.030026763677597046,
            0.03897179290652275,
            -0.0377313531935215,
            -0.0018880325369536877,
            0.04025882109999657,
            -0.010483277961611748,
            -0.04498278349637985,
            0.027901090681552887,
            -0.010888511314988136,
            0.047725558280944824,
            0.02189766615629196,
            -0.04166846722364426,
            -0.03370864316821098,
            -0.06467807292938232,
            -0.03930449113249779,
            -0.025934848934412003,
            0.002638635691255331,
            -0.045274317264556885,
            -0.004330188035964966,
            0.013592030853033066,
            -0.01963338814675808,
            -0.05208176374435425,
            0.0005001723766326904,
            -0.023673415184020996,
            0.05065048485994339,
            -0.008376174606382847,
            -0.060440704226493835,
            -0.018493957817554474,
            0.024310022592544556,
            -0.020307227969169617,
            -0.019707269966602325,
            0.03189477324485779,
            -0.01900525949895382,
            -0.03747376799583435,
            -0.019064713269472122,
            0.04748261719942093,
            -0.04610222578048706,
            -0.027026724070310593,
            0.021710779517889023,
            0.024452004581689835,
            0.045447103679180145,
            -0.076652392745018,
            -0.04999665170907974,
            -0.03680645674467087,
            0.03026212379336357,
            0.016630906611680984,
            0.0051002660766243935,
            0.14911314845085144,
            0.15072178840637207,
            0.00923701748251915,
            0.015872735530138016,
            0.049200210720300674,
            -0.22935259342193604,
            -0.0811557024717331,
            -0.054537393152713776,
            -0.12367434054613113,
            -0.0039404649287462234,
            -0.03067369945347309,
            0.03276745229959488,
            0.013233376666903496,
            -0.03139958903193474,
            0.0009927600622177124,
            -0.00012267474085092545,
            0.07958832383155823,
            -0.009112555533647537,
            -0.003124064765870571,
            0.0009525332134217024,
            0.06587796658277512,
            -0.04196219891309738,
            0.025546938180923462,
            -0.010161641985177994,
            -0.01906421035528183,
            0.017454687505960464,
            0.024450570344924927,
            -0.04396030306816101,
            -0.008656306192278862,
            0.005591163411736488,
            0.016589965671300888,
            0.04628650099039078,
            -0.027770772576332092,
            0.0538841113448143,
            -0.005188172683119774,
            -0.03153302147984505,
            0.02170173078775406,
            -0.00931957270950079,
            -0.03425639495253563,
            0.19617900252342224,
            -0.015376292169094086,
            0.003421399276703596,
            0.01594363898038864,
            0.013341140002012253,
            -0.03029310703277588,
            0.09317538142204285,
            -0.08000674843788147,
            -0.017563991248607635,
            -0.03532508760690689,
            -0.003890708088874817,
            -0.042701516300439835,
            -0.024081099778413773,
            -0.04351665452122688,
            0.007534602656960487,
            -0.06073674559593201,
            0.030219843611121178,
            -0.0009291339665651321,
            -0.0029501011595129967,
            0.05454569309949875,
            0.0813390240073204,
            0.014353971928358078,
            -0.04018477723002434,
            0.13380126655101776,
            -0.00856538861989975,
            0.08623281866312027,
            0.010910708457231522,
            0.043559249490499496,
            0.006864927709102631,
            0.00028985459357500076,
            0.06918682903051376,
            0.022139867767691612,
            -0.024997036904096603,
            0.00797075405716896,
            -0.004871688783168793,
            -0.08045358210802078,
            0.007502652704715729,
            -0.044994041323661804,
            0.047270502895116806,
            0.02513553574681282,
            0.006943782791495323,
            -0.05610208958387375,
            0.033372581005096436,
            0.004640992730855942,
            -0.02649625763297081,
            0.06776650995016098,
            0.05076763778924942,
            -0.021108979359269142,
            0.009497752413153648,
            -0.02914348989725113,
            0.015303187072277069,
            0.02188785932958126,
            -0.04583704471588135,
            0.014855118468403816,
            0.04642407223582268,
            -0.01956576108932495,
            -0.00318313529714942,
            0.0011340081691741943,
            -0.12546031177043915,
            0.0014062346890568733,
            -0.0005502477288246155,
            0.06383220851421356,
            -0.008989561349153519,
            -0.04801291227340698,
            -0.015398276038467884,
            -0.03426139056682587,
            0.049436405301094055,
            0.0366746187210083,
            -0.004240971989929676,
            0.02623121812939644,
            -0.023968517780303955,
            -0.0007126722484827042,
            0.001949553843587637,
            -0.014677315950393677,
            -0.001904396340250969,
            -0.02999013289809227,
            0.03827837109565735,
            -0.024656902998685837,
            -0.048540450632572174,
            0.002754119224846363,
            -0.08365058153867722,
            0.020716041326522827,
            -0.01280675083398819,
            -0.08779934793710709,
            0.12326398491859436,
            -0.0032182633876800537,
            -0.0501554012298584,
            0.022518165409564972,
            -0.01556350663304329,
            0.05209595710039139,
            0.0085966307669878,
            -0.06942646950483322,
            0.045534320175647736,
            -0.00578646082431078,
            -0.055928587913513184,
            0.020991822704672813,
            0.0013705785386264324,
            -0.01036177109926939,
            0.011554832570254803,
            0.03841736167669296,
            -0.002618268132209778,
            -0.04847640544176102,
            0.03035285323858261,
            -0.019686853513121605,
            0.049088165163993835,
            0.012750398367643356,
            0.06049343943595886,
            -0.02412787824869156,
            0.06724320352077484,
            0.016486473381519318,
            -0.04594732075929642,
            -0.0026304805651307106,
            -0.036902956664562225,
            0.002569162752479315,
            -0.00014919135719537735,
            0.01766360178589821,
            -0.06144189089536667,
            0.04905508831143379,
            -0.011410664767026901,
            0.015237383544445038,
            0.03886403143405914,
            0.01352157536894083,
            0.06957195699214935,
            0.0016413565026596189,
            0.01825695112347603,
            -0.0841650739312172,
            -0.00022459006868302822,
            -0.020896414294838905,
            0.009291251190006733,
            0.05007804185152054,
            0.27765706181526184,
            0.021009907126426697,
            0.0018588071689009666,
            -0.012659844942390919,
            0.0038313791155815125,
            0.019322780892252922,
            -0.2333310842514038,
            0.03955863043665886,
            -0.03524944186210632,
            -0.006516322493553162,
            0.05229567736387253,
            -0.02793015167117119,
            0.03623076155781746,
            -0.002003701403737068,
            0.01708892360329628,
            0.0024769259616732597,
            0.034777648746967316,
            -0.041565533727407455,
            0.0037049558013677597,
            0.06114453822374344,
            0.04129695147275925,
            -0.039246171712875366,
            -0.02169460989534855,
            -0.06302838027477264,
            -0.03024090826511383,
            0.04702383652329445,
            0.04337193816900253,
            -0.01138278841972351,
            0.008822453208267689,
            0.04299803823232651,
            0.022313879802823067,
            -0.09484855085611343,
            0.03609006106853485,
            -0.0184711255133152,
            -0.004643524065613747,
            0.02068990468978882,
            -0.030142512172460556,
            0.0418650321662426,
            9.124353528022766e-05,
            -0.014125514775514603,
            -0.2054624855518341,
            -0.0003086104989051819,
            0.01738029718399048,
            0.04223666712641716,
            0.027371393516659737,
            0.01482236199080944,
            -0.037383072078228,
            -0.007331555709242821,
            -0.04849664866924286,
            -0.019333213567733765,
            -0.02906832844018936,
            0.3361321687698364,
            -0.00596237275749445,
            0.013198018074035645,
            0.02916640043258667,
            -0.10254795849323273,
            0.0462697371840477,
            0.3495946526527405,
            0.028758546337485313,
            -0.04339578002691269,
            -0.0008453764021396637,
            -0.03205743804574013,
            0.0699489414691925,
            0.03447224199771881,
            -0.01065768487751484,
            0.21415895223617554,
            0.010544578544795513,
            0.007956255227327347,
            -0.01740242913365364,
            0.05431479960680008,
            0.02203347533941269,
            -0.07078048586845398,
            0.03480341285467148,
            0.021808940917253494,
            0.00600171834230423,
            -0.0376705676317215,
            0.0032020248472690582,
            -0.02339954674243927,
            0.07586252689361572,
            0.027727212756872177,
            0.011189989745616913,
            0.029144808650016785,
            0.05066901817917824,
            0.05432051792740822,
            0.3274286985397339,
            -0.07918836921453476,
            0.033229827880859375,
            0.026265054941177368,
            0.024852456524968147,
            0.08226603269577026,
            0.015150884166359901,
            -0.011139951646327972,
            -0.011277871206402779,
            0.0034919381141662598,
            0.06691442430019379,
            -0.027442514896392822,
            -0.050041988492012024,
            0.005785122513771057,
            0.024893730878829956,
            0.0035918857902288437,
            -0.04822201281785965,
            -0.05800795555114746,
            -0.07670491188764572,
            0.022946730256080627,
            0.0395541712641716,
            -0.022454334422945976,
            -0.01573016494512558,
            -0.009183813817799091,
            0.0028355305548757315,
            0.16962923109531403,
            -0.009242627769708633,
            -0.07980874180793762,
            0.027077920734882355,
            -0.015788108110427856,
            0.032355889678001404,
            -0.007971839979290962,
            0.0012781128752976656,
            -0.31015515327453613,
            0.0021107010543346405,
            -0.0029728570953011513,
            -0.0028837043792009354,
            0.03708570450544357,
            -0.03489931300282478,
            0.06425771117210388,
            0.004635928198695183,
            0.10330172628164291,
            -0.0001922177616506815,
            0.06202515959739685,
            0.01972757652401924,
            0.007552778348326683,
            -0.028078433126211166,
            -0.024214591830968857,
            0.0011132266372442245,
            -0.005380398593842983,
            -0.00045109260827302933,
            0.08049188554286957,
            -0.11344913393259048,
            -0.062158457934856415,
            -0.07581020146608353,
            0.021670028567314148,
            0.011174436658620834,
            0.026198789477348328,
            -0.01711920276284218,
            -0.009776866994798183,
            0.02424933761358261,
            0.08015203475952148,
            0.028446249663829803,
            -0.02001211792230606,
            -0.02605573460459709,
            0.013542722910642624,
            0.04364996403455734,
            -0.0259990431368351,
            0.03930509090423584,
            0.0002429010346531868,
            -0.016649510711431503,
            -0.0004797675646841526,
            0.01879182457923889,
            -0.033521585166454315,
            0.08241448551416397,
            -0.0204496830701828,
            0.047879185527563095,
            -0.043628595769405365,
            0.019306547939777374,
            0.05750269442796707,
            -0.18219928443431854,
            0.39947232604026794,
            0.002701749559491873,
            -0.0031557120382785797,
            0.0001279190182685852,
            -0.024575835093855858,
            -0.03960650414228439,
            0.004957623779773712,
            -0.06266295164823532,
            -0.01525145210325718,
            -0.004741232842206955,
            -0.039273276925086975,
            0.031023409217596054,
            0.047444991767406464,
            0.00394443329423666,
            -0.004800572991371155,
            -0.0933217853307724,
            0.00684964656829834,
            -0.027915332466363907,
            -0.022351685911417007,
            -0.004314858466386795,
            0.032568030059337616,
            0.06598332524299622,
            0.01694333925843239,
            -0.047247473150491714,
            0.0160016231238842,
            -0.02133917436003685,
            0.020403292030096054,
            0.04371655732393265,
            -0.09683801978826523,
            0.023428484797477722,
            -0.08116690814495087,
            -0.0015467971097677946,
            0.050493303686380386,
            0.021973855793476105,
            -0.0002988465130329132,
            -0.018144961446523666,
            0.00449720025062561,
            -0.015001030638813972,
            -0.03504087030887604,
            -0.178795725107193,
            0.015659864991903305,
            5.383044481277466e-05,
            -0.042815905064344406,
            -0.004186470527201891,
            0.05815725401043892,
            0.000437234528362751,
            -0.0627448707818985,
            -0.0028389636427164078,
            -0.008194463327527046,
            -0.021727176383137703,
            -0.028183508664369583,
            0.0983487144112587,
            -0.01849004253745079,
            -0.058134280145168304,
            0.0030360333621501923,
            0.046793319284915924,
            -0.030112452805042267,
            0.015477174893021584,
            -0.030574243515729904,
            0.039707913994789124,
            0.02254011109471321,
            -0.04395752772688866,
            -0.04233831539750099,
            -0.019076889380812645,
            -0.020621927455067635,
            -0.023907452821731567,
            -0.013578701764345169,
            0.024415286257863045,
            0.03267446905374527,
            0.0927933007478714,
            0.04624929651618004,
            0.1071465015411377,
            0.0027204714715480804,
            -0.04699775576591492,
            0.04862191900610924,
            0.025757785886526108,
            0.011520197615027428,
            0.006090730428695679,
            -0.04222529008984566,
            -0.03745678439736366,
            -0.05611375346779823,
            -0.0069549474865198135,
            -0.011682444252073765,
            -0.0597367063164711,
            0.02864793688058853,
            -0.08482147008180618,
            -0.05140141025185585,
            -0.022834384813904762,
            0.01785258948802948,
            -0.006202103570103645,
            0.0037858178839087486,
            -0.059331927448511124,
            -0.028644919395446777,
            0.004476776346564293,
            0.012258662842214108,
            0.0685773640871048,
            -0.02124987542629242,
            -0.06374940276145935,
            -0.004610519856214523,
            0.01025453582406044,
            0.016101568937301636,
            0.230423241853714,
            0.014233915135264397,
            0.01767047867178917,
            0.005756979808211327,
            -0.026237377896904945,
            0.08611979335546494,
            0.0033890455961227417,
            0.0029540229588747025,
            0.029819678515195847,
            -0.01680765300989151,
            0.006518157199025154,
            -0.002910824492573738,
            0.02418217808008194,
            -0.035006649792194366,
            -0.008169542998075485,
            -0.0857851505279541,
            0.0031095556914806366,
            0.004073640331625938,
            0.021594339981675148,
            -0.041540905833244324,
            0.002345114480704069,
            -0.0201843474060297,
            0.008546076714992523,
            0.014519963413476944,
            0.007354315370321274,
            0.039554040879011154,
            -0.04347289353609085,
            0.061096712946891785,
            0.11742725223302841,
            -0.00019575376063585281,
            -0.27884411811828613,
            0.0043167974799871445,
            -0.05388232320547104,
            -0.03565938398241997,
            -0.04504401609301567,
            0.010011635720729828,
            -0.01573961414396763,
            -0.00044307485222816467,
            -0.028079133480787277,
            0.38169175386428833,
            -0.017418431118130684,
            0.008171958848834038,
            0.00850101001560688,
            0.001794150099158287,
            -0.8090615272521973,
            0.042654335498809814,
            0.010850217193365097,
            0.07236636430025101,
            -0.028469808399677277,
            -0.04033375903964043,
            -0.008870264515280724,
            0.007873402908444405,
            0.03298936039209366,
            0.0026748329401016235,
            0.003938577603548765,
            0.04036758840084076,
            0.009093787521123886,
            -0.05734936520457268,
            -0.003021394833922386,
            0.04859711974859238,
            -0.03838106989860535,
            -0.11293992400169373,
            -0.003996484912931919,
            0.0013002929044887424,
            -0.0008178725838661194,
            0.005891929380595684,
            0.009099610149860382,
            0.04965817928314209,
            -0.002015994396060705,
            -0.04110545665025711,
            0.017285894602537155,
            0.03586960211396217,
            -0.025732262060046196,
            0.01110922172665596,
            0.15134695172309875,
            0.021432649344205856,
            0.04766605794429779,
            -0.03793932497501373,
            0.013322632759809494,
            -0.008997328579425812,
            0.0035546403378248215,
            -0.00261129904538393,
            -0.05556178838014603,
            -0.04919564723968506,
            -0.04214581474661827,
            0.007004061713814735,
            0.0003886716440320015,
            -0.024913925677537918,
            0.0125974016264081,
            -0.06192043423652649,
            0.0029436310287564993,
            -0.03409620374441147,
            -0.03200945258140564,
            -0.1030392050743103,
            -0.022709455341100693,
            0.0515398308634758,
            -0.017509764060378075,
            -0.03377928584814072,
            -0.0334441140294075,
            0.02208065427839756,
            0.051340363919734955,
            0.018955372273921967,
            -0.010058791376650333,
            -0.04015970230102539,
            0.07677337527275085,
            -0.06195305287837982,
            0.0555989071726799,
            0.022112581878900528,
            0.02301432006061077,
            -0.006368591450154781,
            0.008483638986945152,
            -0.004936681129038334,
            0.0020196475088596344,
            0.01733998768031597,
            0.0466570109128952,
            -0.00807168334722519,
            -0.06146883964538574,
            0.1398172378540039,
            0.02105705440044403,
            0.23199808597564697,
            -0.0012891599908471107,
            0.04103703051805496,
            0.036836374551057816,
            -0.011153552681207657,
            0.026447810232639313,
            0.0002992302179336548,
            -0.08571746200323105,
            -0.07880380749702454,
            -0.10906383395195007,
            -0.009217280894517899,
            0.010269474238157272,
            -0.023154497146606445,
            0.029528342187404633,
            -0.03838326781988144,
            -0.02902260608971119,
            -0.010754523798823357,
            0.012255270034074783,
            -0.03045148029923439,
            -0.07164987921714783,
            0.010541794821619987,
            -0.002594245132058859,
            -0.03284953907132149,
            -0.014941900968551636,
            0.0016082413494586945,
            -0.027146566659212112,
            -0.030459702014923096,
            -0.003878102172166109,
            -0.02772710472345352,
            -0.002091570757329464,
            0.0327448807656765,
            0.09437201917171478,
            0.014143340289592743,
            -0.004946552217006683,
            0.02879556268453598,
            -0.04534416273236275,
            -0.04378107935190201,
            -0.010036008432507515,
            0.03928985446691513,
            0.008172612637281418,
            -0.016743440181016922,
            -0.027534401044249535,
            -0.045415498316287994,
            -0.0015997826121747494,
            -0.018458813428878784,
            -0.016519099473953247,
            -0.022653456777334213,
            -0.010570183396339417,
            0.004871124401688576,
            0.03790722042322159,
            -0.03133637458086014,
            -0.003290184773504734,
            -0.007665995508432388,
            0.018671713769435883,
            -0.0013137944042682648,
            -0.06266995519399643,
            -0.019142471253871918,
            0.02059248834848404,
            0.0061823297291994095,
            -0.04865243285894394,
            -0.05281137302517891,
            0.01716790348291397,
            0.048308469355106354,
            -0.03891856595873833,
            -0.020916800945997238,
            -0.010999076999723911,
            -0.12430420517921448,
            0.007130768150091171,
            -0.018351644277572632,
            -0.013133533298969269,
            -0.153034508228302,
            -0.03494895622134209,
            0.1691097766160965,
            0.038780517876148224,
            -0.0007865098305046558,
            0.003328876569867134,
            0.024050308391451836,
            0.037409450858831406,
            -0.010492329485714436,
            -0.02471204288303852,
            -0.056420259177684784,
            -0.08916895091533661,
            -0.09235293418169022,
            0.02251872420310974,
            0.037353575229644775,
            -0.05127763748168945,
            0.03129515424370766,
            0.0022381413727998734,
            0.03603426367044449,
            -0.04770351201295853,
            0.030310165137052536,
            0.013410684652626514,
            -0.020808683708310127,
            0.0003854120150208473,
            0.015194249339401722,
            0.035252682864665985,
            0.03132538124918938,
            0.05528787896037102,
            0.004759825766086578,
            -0.009923593141138554,
            -0.00592037895694375,
            0.04829484596848488,
            -0.01766490563750267,
            0.0012643616646528244,
            -0.011467747390270233,
            0.0009562540799379349,
            -0.029350493103265762,
            0.01731700636446476,
            -0.03565102815628052,
            0.11976874619722366,
            -0.030524812638759613,
            -0.05455102026462555,
            -0.028793083503842354,
            0.0013845674693584442,
            -0.06772033870220184,
            0.014631077647209167,
            -0.03503964841365814,
            0.01913308911025524,
            -0.005374111235141754,
            0.0006179735064506531,
            0.011862624436616898,
            -0.011276003904640675,
            0.028746377676725388,
            0.030723141506314278,
            -0.014809456653892994,
            0.11732926964759827,
            -0.09305792301893234,
            0.006877189502120018,
            0.009341585449874401,
            0.029712826013565063,
            0.036158207803964615,
            0.0010917219333350658,
            -0.06402939558029175,
            0.006435178220272064,
            0.009703158400952816,
            -0.009825768880546093,
            0.0166952982544899,
            0.06441842019557953,
            -0.03577623516321182,
            0.019444920122623444,
            -0.030641011893749237,
            -0.04807862639427185,
            0.01728256791830063,
            -0.013734567910432816,
            0.059995464980602264,
            0.052435390651226044,
            0.01862911507487297,
            -0.0023229140788316727,
            -0.05987078323960304,
            0.019506758078932762,
            0.0006542215123772621,
            -0.059793621301651,
            0.005990222096443176,
            -0.04680251330137253,
            -0.019307803362607956,
            0.01542995497584343,
            -0.0040241689421236515,
            -0.011911382898688316,
            0.032753318548202515,
            -0.052050039172172546,
            -0.0003208137350156903,
            -0.05046553537249565,
            0.04396665096282959,
            -0.015692105516791344,
            0.016225073486566544,
            -0.00030663423240184784,
            -0.02871667593717575,
            0.022246941924095154,
            0.07968251407146454,
            -0.021220574155449867,
            -0.03518946096301079,
            -0.030421076342463493,
            -0.0016075285384431481,
            -0.0005172528326511383,
            -0.018755022436380386,
            0.00618814118206501,
            0.011279810220003128,
            -0.05726340413093567,
            -0.060781314969062805,
            -0.07151768356561661,
            0.01519627496600151,
            0.018672551959753036,
            0.002015107311308384,
            -0.0036110542714595795,
            0.0017546024173498154,
            0.1780497133731842,
            0.016010597348213196,
            -0.11117826402187347,
            0.004601234570145607,
            -0.0027087610214948654,
            0.026832126080989838,
            -0.04242781549692154,
            -0.009245898574590683,
            -0.0006581214838661253,
            -0.12237483263015747,
            -0.003537096083164215,
            -0.0419582799077034,
            -0.03646315261721611,
            -0.036581363528966904,
            -0.03408467024564743,
            0.01107010804116726,
            0.029695402830839157,
            0.013232853263616562,
            0.0644034743309021,
            0.008748800493776798,
            -0.05854933708906174,
            -0.023791050538420677,
            0.03362606465816498,
            -0.05919970944523811,
            0.030590694397687912,
            0.029948225244879723,
            0.024065595120191574,
            -0.02814936451613903,
            0.03545771539211273,
            0.01245686411857605,
            0.010808054357767105,
            -0.01095927506685257,
            0.03187798708677292,
            -0.00309195788577199,
            0.011741808615624905,
            0.07915308326482773,
            -0.0011309710098430514,
            -0.03564687818288803,
            -0.05996423214673996,
            -0.021913927048444748,
            0.02161519229412079,
            -0.004290137439966202,
            0.005145754665136337,
            -0.07123089581727982,
            -0.0025888532400131226,
            -0.0014297098387032747,
            -0.03642825782299042,
            -0.01275758445262909,
            -0.10404784977436066,
            0.004557571839541197,
            -0.003634292632341385,
            -0.054057277739048004,
            -0.012310110032558441,
            0.06027811020612717,
            0.022099008783698082,
            0.015104630962014198,
            -0.031386591494083405,
            0.038028329610824585,
            -0.0066018905490636826,
            -0.002298962324857712,
            -0.013392902910709381,
            -0.02594953030347824,
            -0.01993173360824585,
            0.0159962959587574,
            0.0012318156659603119,
            -0.030741719529032707,
            0.0017456370405852795,
            0.02926880121231079,
            -0.014866629615426064,
            -0.011242700740695,
            -0.018468165770173073,
            -0.0026781950145959854,
            0.0488622672855854,
            0.03531285375356674,
            0.033381637185811996,
            -0.017826400697231293,
            -0.07437601685523987,
            -0.017138436436653137,
            0.02584848180413246,
            -0.012753752991557121,
            0.03859991952776909,
            0.005034849047660828,
            0.0001335442066192627,
            -0.008073690347373486,
            -0.003964381292462349,
            -0.027582958340644836,
            0.010684939101338387,
            -0.004234790336340666,
            -0.007964100688695908,
            -0.009871510788798332,
            0.03160792589187622,
            0.046158742159605026,
            -0.04798181727528572,
            0.00787309743463993,
            -0.07617130130529404,
            0.00118955597281456,
            -0.01673062890768051,
            -0.00987115129828453,
            0.033035848289728165,
            0.16868999600410461,
            0.029031088575720787,
            -0.027184024453163147,
            0.030199017375707626,
            -0.01496286690235138,
            0.015700243413448334,
            0.2420780062675476,
            -0.047281794250011444,
            -0.027983881533145905,
            -0.037029609084129333,
            -0.13479258120059967,
            0.01702583022415638,
            -0.04189027100801468,
            -0.07920308411121368,
            -0.0028936732560396194,
            -0.002784010022878647,
            -0.007495129480957985,
            0.008087100461125374,
            0.015982741490006447,
            0.03762730583548546,
            -0.06574222445487976,
            0.09473060816526413,
            -0.10701435804367065,
            -0.011427076533436775,
            -0.02940179407596588,
            0.04781132936477661,
            0.004330791532993317,
            0.060812074691057205,
            -0.5447970628738403,
            0.032692618668079376,
            -0.018404757604002953,
            0.03543390706181526,
            -0.03536687046289444,
            -0.021262217313051224,
            0.052222318947315216,
            -0.02298816852271557,
            0.043335847556591034,
            -0.05273737385869026,
            0.005521785467863083,
            -0.07326231151819229,
            0.0023294752463698387,
            0.05184364691376686,
            0.001117616891860962,
            0.08879458904266357,
            -0.03162350133061409,
            0.013613983057439327,
            -0.012170815840363503,
            0.08569477498531342,
            0.02177289128303528,
            -0.016777383163571358,
            0.02934809774160385,
            -0.025736242532730103,
            0.07348307967185974,
            -0.03749420493841171,
            0.0018478985875844955,
            -0.0003275349736213684,
            0.02444123476743698,
            -0.006963435560464859,
            -0.003298295196145773,
            -0.06538332998752594,
            -0.01437547616660595,
            0.017813222482800484,
            -0.03630344569683075,
            0.08851423114538193,
            0.010796554386615753,
            -0.019042477011680603,
            0.0009503888431936502,
            0.04981398209929466,
            -0.019323982298374176,
            -0.027476351708173752,
            -0.04619087651371956,
            0.04451029747724533,
            -0.029919136315584183,
            0.010069435462355614,
            0.004129767417907715,
            0.017602475360035896,
            0.01127605140209198,
            0.01265757903456688,
            0.024906083941459656,
            -0.04057396575808525,
            -0.04972708970308304,
            -0.03862769156694412,
            -0.038102246820926666,
            -0.01812627539038658,
            0.0004452342400327325,
            0.008802607655525208,
            0.07429096102714539,
            -0.009096819907426834,
            0.011647840030491352,
            -0.08595338463783264,
            -0.06823746860027313,
            0.019204922020435333,
            -0.015204597264528275,
            -0.09247239679098129,
            -0.05252787843346596,
            -0.043222006410360336,
            0.013561215251684189,
            -0.07625777274370193,
            -0.06332449615001678,
            -0.14402635395526886,
            0.04717336967587471,
            0.03836353123188019,
            -0.01853153109550476,
            -0.004393767565488815,
            -0.018384218215942383,
            -0.02546454221010208,
            -0.01393543928861618,
            -0.037730805575847626,
            -0.031975165009498596,
            0.004116477444767952,
            -0.010102879256010056,
            0.09577891230583191,
            0.0401126891374588,
            -0.046430908143520355,
            0.026219042018055916,
            0.021149948239326477,
            0.0010567139834165573,
            -0.012331582605838776,
            -0.0008299276232719421,
            0.00045214220881462097,
            0.007138833403587341,
            -0.0022696703672409058,
            -0.019246507436037064,
            -0.04363013431429863,
            -0.004453592002391815,
            -0.01980661228299141,
            0.01546499878168106,
            0.09156829118728638,
            -0.0076989782974123955,
            0.07146971672773361,
            -0.010574743151664734,
            -0.0016325078904628754,
            -0.04143684357404709,
            -0.001498446799814701,
            -0.02832886204123497,
            0.40033549070358276,
            -0.013988737016916275,
            0.02508951723575592,
            0.018318094313144684,
        ]
    ]
)


@pytest.mark.slow
def test_clip_torch_image_prediction_for_numpy(
    clip_rn50_pytorch_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)

    # when
    embeddings = model.embed_images(dog_image_numpy)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING)


@pytest.mark.slow
def test_clip_torch_image_prediction_for_torch_tensor(
    clip_rn50_pytorch_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)

    # when
    embeddings = model.embed_images(dog_image_torch)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING)


@pytest.mark.slow
def test_clip_predictions_for_image_are_comparable_with_reference_implementation(
    clip_rn50_pytorch_path: str, dog_image_torch: np.ndarray, dog_image_pil: Image
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    inference_model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)
    original_model, preprocess = clip.load("RN50", device=torch.device("cpu"))
    dog_image_original_preprocessing = (
        preprocess(dog_image_pil).unsqueeze(0).to(torch.device("cpu"))
    )

    # when
    with torch.no_grad():
        original_image_features = original_model.encode_image(
            dog_image_original_preprocessing
        )
    inference_image_features = inference_model.embed_images(dog_image_torch)

    # then
    similarity = F.cosine_similarity(original_image_features, inference_image_features)
    assert (
        similarity >= 0.94
    ), "We get different results due different input scaling PIL vs Torch"


@pytest.mark.slow
def test_clip_torch_image_text_embeddings(
    clip_rn50_pytorch_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path, max_batch_size=2)

    # when
    embeddings = model.embed_text(["This is example text"] * 4)

    # then
    assert tuple(embeddings.shape) == (4, 1024)


@pytest.mark.slow
def test_clip_torch_image_text_embeddings_on_pair_with_reference_implementation(
    clip_rn50_pytorch_path: str,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    inference_model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)
    original_model, _ = clip.load("RN50", device=torch.device("cpu"))
    text = clip.tokenize(["This is example text"]).to(torch.device("cpu"))

    # when
    with torch.no_grad():
        original_text_features = original_model.encode_text(text)
    inference_text_features = inference_model.embed_text("This is example text")

    # then
    assert torch.allclose(original_text_features, inference_text_features)


@pytest.mark.slow
@pytest.mark.onnx_extras
def test_clip_onnx_image_prediction_for_numpy(
    clip_rn50_onnx_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_images(dog_image_numpy)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
@pytest.mark.onnx_extras
def test_clip_onnx_image_prediction_for_torch_tensor(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_images(dog_image_torch)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
@pytest.mark.onnx_extras
def test_clip_onnx_image_prediction_similar_to_reference_implementation(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
    dog_image_pil: Image,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    inference_model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    original_model, preprocess = clip.load("RN50", device=torch.device("cpu"))
    dog_image_original_preprocessing = (
        preprocess(dog_image_pil).unsqueeze(0).to(torch.device("cpu"))
    )

    # when
    with torch.no_grad():
        original_image_features = original_model.encode_image(
            dog_image_original_preprocessing
        )
    inference_image_features = inference_model.embed_images(dog_image_torch)

    # then
    similarity = F.cosine_similarity(original_image_features, inference_image_features)
    assert (
        similarity >= 0.94
    ), "We get different results due different input scaling PIL vs Torch"


@pytest.mark.slow
@pytest.mark.onnx_extras
def test_clip_onnx_image_prediction_for_text(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_text("This is example text")

    # then
    assert tuple(embeddings.shape) == (1, 1024)


@pytest.mark.slow
@pytest.mark.onnx_extras
def test_clip_onnx_image_prediction_for_text_comparable_with_reference_implementation(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    inference_model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    original_model, _ = clip.load("RN50", device=torch.device("cpu"))
    text = clip.tokenize(["This is example text"]).to(torch.device("cpu"))

    # when
    with torch.no_grad():
        original_text_features = original_model.encode_text(text)
    inference_text_features = inference_model.embed_text("This is example text")

    # then
    assert torch.allclose(original_text_features, inference_text_features, atol=1e-5)
